<html>
	<head>
		<script src="./three.min.js"></script>
		<script src="./listener.js"></script>
		<script src="./radialTree.js"></script>
		<script src="./room.js"></script>
		<script src="./block.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.5.1/math.js"></script>
	</head>
	<body>
		<script>


var scene = new THREE.Scene();
camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 1000 );
//camera.position.set(0, 100, 250);
camera.focalLength = 20;
camera.updateProjectionMatrix();	

var renderer = new THREE.WebGLRenderer({antialias: true});
renderer.setSize( window.innerWidth, window.innerHeight );
//For spotlight
document.body.appendChild( renderer.domElement );

//Lighting
var ambient = new THREE.AmbientLight( 0xffffff, 0.7 );
scene.add(ambient);

w = 1000;
h = 500;

var spotlight = new THREE.SpotLight(new THREE.Color(1, 1, 1));

renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.shadowMapSoft = true;

spotlight.position.set(0, 200, 600);
spotlight.castShadow = true;
spotlight.angle = 0.5
spotlight.intensity = 1;
spotlight.penumbra = 0.5;
spotlight.distance = w * 2;
spotlight.decay = 3;

spotlight.shadow.mapSize.width = 2048 + 1024;
spotlight.shadow.mapSize.height = 2048 + 1024;


scene.add(spotlight);

var sphelper = new THREE.SpotLightHelper(spotlight);
scene.add(sphelper);

group = new THREE.Object3D();
group.position.z -= h;
group.position.y -= h/2.75;

var room = room();
group.add(room);

//Initial stack push
//var stack = [cursorBlock(0, 0, 0)];
var stack = [];
//group.add(stack[0]);

var cursor = cursorWireframe(0, 0, 0);
group.add(cursor);

scene.add(group);

function collisionDetection() {
	if(stack.length > 0) {
		result = cursorTouchedABlock();
		if(result) {
			//console.log("Touching");
			cursor.translateY(20);
		}else{
			if(cursorOnTopOfBlock()) {

			}else{
				dif = cursor.position.y - 0;
				cursor.translateY(-dif);
				//console.log(dif);
				//console.log("Not on a block");
			}
		}
	}
}

function cursorTouchedABlock() {
	for( i = 0; i < stack.length; i++) {
		if(cursorCollision(cursor, stack[i])){
			return stack[i];
		}
	}
	return false;
}

function cursorOnTopOfBlock() {
	for( i = 0; i < stack.length; i++) {
		if(blockUnderneath(cursor, stack[i])) {
			return true;
		}
	}
	return false;
}

function render() {
	requestAnimationFrame( render );
	collisionDetection();
	//camera.rotation.y+=0.01;
	//camera.lookAt(scene.position);
	renderer.render( scene, camera );
}

function onKeyDown(e) {
	e = e || window.event;

   if (e.keyCode == '38') {
        // up arrow
        cursor.translateZ(-30);
    }
    else if (e.keyCode == '40') {
        // down arrow
        cursor.translateZ(30);
    }
    else if (e.keyCode == '37') {
       // left arrow
       cursor.translateX(-30);
    }
    else if (e.keyCode == '39') {
       // right arrow
       cursor.translateX(30);
    }else if (e.keyCode == 32) {//spacebar
    	b = cursorBlock(cursor.position.x, cursor.position.y, cursor.position.z);
    	group.add(b);
    	stack.push(b);
    	
    }else if (e.keyCode == 13) {// enter
    	console.log(stack.length);
    	b = stack.pop();
    	console.log(stack.length);
    	group.remove(b);
    }else if(e.keyCode == 67) {// 'c'
    		    	for( i = 0; i < stack.length; i++) {
			if(blockUnderneath(cursor, stack[i])) {
				console.log(stack[i].material.color);
				console.log(room.material.color);
				room.material.color = stack[i].material.color;
			}
		}
    }
}

document.onkeydown = onKeyDown;

var cx = -100;
var cy = 50;
var cz = -10;

voiceListener(function(result) {
	cube(group, cx, cy, cz);
	cx+=20;
});

render();

			
		</script>
	</body>
</html>